{% extends 'documentos/documento_list.html' %}

{% load comments documentostags humanize %}

{% block extra_head %}

	<script type="text/javascript" src="{{ MEDIA_URL }}js/jquery.raty.min.js"></script>
	
	<script type="text/javascript">
		function on_cover_error(source) {
			$(source).unbind("error").attr("src", "{{ MEDIA_URL }}img/Blank.jpg");
		}
	</script>
	
	<script type="text/javascript">
		$(function() {
			
			$('#star').raty({
				path : '{{ MEDIA_URL }}img/',
				half :  true,
				hintList: ['','','','',''],
				start : {{ promedio_rating }},
				{% if usuario_ya_voto %}
					readOnly : true,
				{% else %}
					readOnly : false,
				{% endif %}
				click : function(score, event) {
				    $.ajax({
				    	  url: "vote/" + score,
				    	  dataType: 'json',
				    	  success: function(exito) {
				    		  window.location = '';				    		  
				    	  }
				    });
				},
			});
		});
	</script>
{% endblock %}

{% block content %}

<h2>{{ documento.titulo }}</h2>

<div id="datos_documento">
	<fieldset class="display-fieldset">
		<div>
			<div id="cover">
				<img src="{{ documento|book_cover }}" onerror="on_cover_error(this)">
			</div>
			
			<div id="details">
				<p><label>Autor:</label> {{ documento.autor }}</p><p/>
				<p><label>Tipo de documento:</label> {{ documento.get_tipo_display }}</p><p/>
				{% if documento.isbn %}<p><label>ISBN:</label> {{ documento.isbn }}</p><p/>{% endif %}
				{% if documento.carrera.all %}<p><label>Carrera:</label> {% for carrera in documento.carrera.all %} {{ carrera }}{% if not forloop.last %}; {% endif %}{% endfor %}</p><p/>{% endif %}
				{% if documento.materia.all %}<p><label>Materia:</label> {% for materia in documento.materia.all %} {{ materia  }}{% if not forloop.last %}; {% endif %}{% endfor %}</p><p/>{% endif %}
				
				<div id="star"></div>
				<p>Valoracion: <b>{{ promedio_rating }}/5</b> ({{ cantidad_votos }} voto{{ cantidad_votos|pluralize }}).</p>
			</div>

			<div class="clear"></div>
		</div>
	</fieldset>
</div>


<h3>Archivos</h3>
<table id="archivos_table">
<thead><tr><th>Archivo</th><th>Subido por</th><th/></tr></thead>
{% for archivo in documento.archivo_set.all %}
<tr {% cycle 'class="odd"' '' %}>
	<td><a href="{{ archivo.link  }}" target="_blank">{{ archivo.link  }}</a></td>
	<td>{{ archivo.subido_por }}</td>
	<td class="actions"><a href="{% url reportar archivo.pk %}">Reportar</a></td>
</tr>
{% endfor %}
<tr>
	<td colspan=3 id="paginator"><a href="{% url add_mirror documento.pk%}">Agregar mirror</a></td>
</tr>
</table>


{% get_comment_count for documento as number_of_comments %}

<div id="comentarios">
	<h3>Comentarios ({{number_of_comments}})</h3>
	{% get_comment_list for documento as comment_list %}
		
	<div id="send_comentario" class="comentario">
			<div class="header">
				<div class="nombre"><strong>Dejar un comentario:</strong></div>
				<div class="clear"></div>
			</div>
			
			{% get_comment_form for documento as form %}
			{% include 'comments/form_add_comment.html' with next=request.path %}
	</div>
	
	{% for comment in comment_list reversed %}
		<div class="comentario">
			<div class="header">
				<div class="nombre"><strong>{{ comment.user_name }}</strong> escribi√≥:</div>
				<div class="fecha">{{ comment.submit_date|date:"d/m/y" }}</div>
				<div class="clear"></div>
			</div>
			<div class="contenido">{{ comment.comment|safe }}</div>
		</div>
	{% endfor %}
	
</div>



{% endblock %}